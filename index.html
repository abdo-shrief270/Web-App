<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css" integrity="sha512-5Hs3dF2AEPkpNAR7UiOHba+lRSJNeM2ECkwxUIxC1Q/FLycGTbNapWXB4tP889k5T5Ju8fs4b1P5z/iB4nMfSQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <div id="logs_status">
        <p></p>
    </div>
    <div class="nav-bar">
        <div class="logo">
            <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M37.3337 28.6666C37.3337 36.9883 28.102 45.6549 25.002 48.3316C24.7132 48.5487 24.3617 48.6662 24.0003 48.6662C23.639 48.6662 23.2875 48.5487 22.9987 48.3316C19.8987 45.6549 10.667 36.9883 10.667 28.6666C10.667 25.1304 12.0718 21.739 14.5722 19.2385C17.0727 16.738 20.4641 15.3333 24.0003 15.3333C27.5365 15.3333 30.9279 16.738 33.4284 19.2385C35.9289 21.739 37.3337 25.1304 37.3337 28.6666Z" stroke="#007BFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M24.0003 33.6666C26.7617 33.6666 29.0003 31.428 29.0003 28.6666C29.0003 25.9052 26.7617 23.6666 24.0003 23.6666C21.2389 23.6666 19.0003 25.9052 19.0003 28.6666C19.0003 31.428 21.2389 33.6666 24.0003 33.6666Z" stroke="#007BFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M36 48H39M39 48C39 51.866 42.134 55 46 55M39 48C39 44.134 42.134 41 46 41M53 48H56M53 48C53 51.866 49.866 55 46 55M53 48C53 44.134 49.866 41 46 41M46 38V41M46 55V58M49 48C49 49.6569 47.6569 51 46 51C44.3431 51 43 49.6569 43 48C43 46.3431 44.3431 45 46 45C47.6569 45 49 46.3431 49 48Z" stroke="#007BFF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>ATS</span>
        </div>
        <div class="list" id="list">
            <li style="color: #007BFF;cursor: pointer;">Home</li>
            <li style="cursor: pointer;"><a href="manual.html">Manual control</a></li>
            <li style="cursor: pointer;"><a href="auto.html">Automatic control</a></li>
            <li style="cursor: pointer;"><a href="live.html">Live Stream</a></li>
            <li style="cursor: pointer;"><a href="test.html">Testing-methods</a></li>
            <li style="cursor: pointer;"><a href="register.html">Register</a></li>
            <li style="cursor: pointer;"><a href="login.html">Login</a></li>
        </div>
        <button id="sidebar-btn">
            <i id="xbar" class="fa-solid fa-bars"></i>
            <i id="xmark" class="fa-regular fa-circle-xmark"></i>
        </button>
        <div class="sidebar">
            <li style="color: #007BFF;cursor: pointer;">Home</li>
            <li style="cursor: pointer;"><a href="manual.html">Manual control</a></li>
            <li style="cursor: pointer;"><a href="auto.html">Automatic control</a></li>
            <li style="cursor: pointer;"><a href="live.html">Live Stream</a></li>
            <li style="cursor: pointer;"><a href="test.html">Testing-methods</a></li>
            <li style="cursor: pointer;"><a href="register.html">Register</a></li>
            <li style="cursor: pointer;"><a href="login.html">Login</a></li>
        </div>
    </div>
    
    <div class="container">
        <div class="con">
            <div class="left">
                <div class="part1">
                    <p class="word1" id="mm">Location on map</p>
                    <div id="more" class="location"></div>
                    <svg id="squaree" class="hide" width="41" height="33" viewBox="0 0 41 33" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="0.5" y="0.5" width="40" height="32" rx="10" fill="black" fill-opacity="0.6"/>
                        <path d="M16.5 7.5H13.5C12.9696 7.5 12.4609 7.71071 12.0858 8.08579C11.7107 8.46086 11.5 8.96957 11.5 9.5V12.5M29.5 12.5V9.5C29.5 8.96957 29.2893 8.46086 28.9142 8.08579C28.5391 7.71071 28.0304 7.5 27.5 7.5H24.5M11.5 20.5V23.5C11.5 24.0304 11.7107 24.5391 12.0858 24.9142C12.4609 25.2893 12.9696 25.5 13.5 25.5H16.5M24.5 25.5H27.5C28.0304 25.5 28.5391 25.2893 28.9142 24.9142C29.2893 24.5391 29.5 24.0304 29.5 23.5V20.5" stroke="#BFBFBF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="part2">
                    <div class="dot">
                        <div id="circle"></div>
                        <p class="word2" id="nn">Live</p>
                    </div>
                    <img id="live" src="" alt="Live Stream" />
                    <svg id="square" width="41" height="33" viewBox="0 0 41 33" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="0.5" y="0.5" width="40" height="32" rx="10" fill="black" fill-opacity="0.6"/>
                        <path d="M16.5 7.5H13.5C12.9696 7.5 12.4609 7.71071 12.0858 8.08579C11.7107 8.46086 11.5 8.96957 11.5 9.5V12.5M29.5 12.5V9.5C29.5 8.96957 29.2893 8.46086 28.9142 8.08579C28.5391 7.71071 28.0304 7.5 27.5 7.5H24.5M11.5 20.5V23.5C11.5 24.0304 11.7107 24.5391 12.0858 24.9142C12.4609 25.2893 12.9696 25.5 13.5 25.5H16.5M24.5 25.5H27.5C28.0304 25.5 28.5391 25.2893 28.9142 24.9142C29.2893 24.5391 29.5 24.0304 29.5 23.5V20.5" stroke="#BFBFBF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
            </div>
            <div class="right">
                <p class="word3">Status</p>
                <div class="con2">
                    <div class="leftside">
                            <p class="move"></p>
                        <div class="kalam">
                            <div class="a">
                            <p>Vehicle status</p>
                            <p id="movingFlag"></p>
                          </div>
                            <div class="a">
                            <p>Person inside</p>
                          <p id="allow" style="color:#28A745;"></p> 
                         </div>
                            <div class="a">
                            <p>Vehicle speed</p>
                            <p id="vspeed"></p>
                          </div>
                        </div>
                     </div>
                     
                    <div class="rightside">
                        <div class="car-status">
                            <p></p>
                        </div>
                        <div class="cam-battery">
                            <div class="space">
                                <p style="color: #767676;">Battery percentage</p>
                                <div class="new_batt">
                                <p id="batt_percentage"></p>
                                <p id="batt_charging"></p>
                            </div>
                            </div>
                            <div class="space">
                                <p  style="color: #767676;">Camera</p>
                                <p id="wecam"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="main.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>    
    <script>
        statusParag = document.getElementsByClassName('move')[0];
        movingFlag = document.getElementById('movingFlag');
        allow= document.getElementById("allow");
        carstatus = document.querySelector(".car-status");
        batt_percentage = document.getElementById("batt_percentage");
        batt_charging = document.getElementById("batt_charging");
        vspeed_p=document.getElementById("vspeed");
        wecam=document.getElementById("wecam");
        logs_status=document.getElementById("logs_status");
        const firebaseConfig = {
          apiKey: "AIzaSyCt3PpT9MV8TBlsgDmjvUngq-ZF1lNYQ2c",
          authDomain: "rpi-car-track.firebaseapp.com",
          databaseURL: "https://rpi-car-track-default-rtdb.firebaseio.com",
          projectId: "rpi-car-track",
          storageBucket: "rpi-car-track.firebasestorage.app",
          messagingSenderId: "603017187064",
          appId: "1:603017187064:web:c8da4c7a71d9745fe8b50d",
          measurementId: "G-GEM4R145LE"
        };
      
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Map Initialization
        var map = L.map('more').setView([0, 0], 15); // Default center (can be updated later)

        // OpenStreetMap Layer
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: ''
        });
        osm.addTo(map);

        // Marker and Circle Variables
        var marker;

        // Function to update map with new coordinates
        function updateMap(latitude, longitude, accuracy = 50) {
            if (marker) {
                map.removeLayer(marker);
            }

            if (circle) {
                map.removeLayer(circle);
            }

            // Add Marker and Circle
            marker = L.marker([latitude, longitude]).addTo(map);
            circle = L.circle([latitude, longitude], { radius: accuracy }).addTo(map);

            // Fit bounds around the marker and circle
            var featureGroup = L.featureGroup([marker, circle]).addTo(map);
            map.fitBounds(featureGroup.getBounds());

            //console.log(`Updated Map: Latitude: ${latitude}, Longitude: ${longitude}`);
        }

        // Fetch Realtime Data from Firebase
        const locationRef = firebase.database().ref('location');
        locationRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const { latitude, longitude, altitude } = data;
                //console.log(`Retrieved Location: Lat: ${latitude}, Long: ${longitude}, Alt: ${altitude}`);
                updateMap(parseFloat(latitude), parseFloat(longitude), 50); // Default accuracy: 50 meters
            } else {
                console.log('No location data found in Firebase.');
            }
        });

        const statusRef = firebase.database().ref('moving');
        statusRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                statusParag.style.color = "#AA2845";
                statusParag.style.backgroundColor  = "#7A28351A";
                statusParag.innerText = "Vehicle is moving";
                movingFlag.style.color = "#A72845";
                movingFlag.innerText = "Moving";
            } else {
                statusParag.style.color = "#28AA45";
                statusParag.style.backgroundColor  = "#28A7451A";
                statusParag.innerText = "Vehicle is not moving";
                movingFlag.style.color = "#28A745";
                movingFlag.innerText = "Not Moving";
            }
        });
                        /////person inside and allowed
        const personallowed = firebase.database().ref('person_allowed');
        personallowed.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                allow.style.color = "#28AA45";
                allow.innerText = "Allowed";
                carstatus.style.color = "#28AA45";
                carstatus.style.backgroundColor  = "#28A7451A";
                carstatus.innerText = "Person is Allowed";
            } else {
                allow.style.color = "#A72845";
                allow.innerText = "Not Allowed";
                carstatus.style.color = "#A72845";
                carstatus.style.backgroundColor  = "#7A28351A";
                carstatus.innerText = "Person is Not Allowed";
            }
        });
                            /////battery Percentage
const batterypercentage = firebase.database().ref('batt_per');
        batterypercentage.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data <= 30){
                batt_percentage.innerText = data + "%";
                batt_percentage.style.color = "#A72845";
            }
            else{ 
                batt_percentage.innerText = data + "%";
                batt_percentage.style.color = "#007BFF";
            }
            });
                                /////battery Charging
 const batteryCharging = firebase.database().ref('batt_chr');
        batteryCharging.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                batt_charging.innerText ="Charging";
                batt_charging.style.color = "#007BFF";
            }
        });
                               ///////Vehicle Speed
        const vspeed = firebase.database().ref('v_speed');
        vspeed.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data <= 80){
                vspeed_p.innerText = data + " Km/h";
                vspeed_p.style.color = "#28AA45";
            }
            else{ 
                vspeed_p.innerText = data + " Km/h";
                vspeed_p.style.color = "#A72845";
            } 
            });
                               ///////Camera Status
        const cameraopr = firebase.database().ref('camera_opr');
        cameraopr.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                wecam.style.color = "#28AA45";
                wecam.innerText = "Operating";
                
            } else {
                wecam.style.color = "#AA2845";
                wecam.innerText ="Not Operating";          
            }
        });
                                       ///////logs-Status 
        // const status_s = firebase.database().ref('log');
        // status_s.on('value', (snapshot) => {
        //     const data = snapshot.val();
        //     if (data) {
        //         const { status, text } = data;

        //         logs_status.innerText = text;
        //         if(status=="info"){
        //             logs_status.style.color = "#000";
        //             logs_status.style.backgroundColor = "#6EACDA";
        //         }
        //         if(status=="warning"){
        //             logs_status.style.backgroundColor = "#FFC107";
        //             logs_status.style.color = "#000";
        //         }
        //         if(status=="error"){
        //             logs_status.style.backgroundColor = "#DC3545";
        //             logs_status.style.color = "#fff";
        //         }
        //     }
        // });
        let stored_log_status="";
        let stored_log_text="";
        const status_s = firebase.database().ref('log');
        status_s.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const { status, text } = data;
                stored_log_status = status;
                stored_log_text = text;
                logs_status.innerText = text;
                if(status=="info"){
                    logs_status.style.color = "#000";
                    logs_status.style.backgroundColor = "#6EACDA";
                }
                else if(status=="warning"){
                    logs_status.style.backgroundColor = "#FFC107";
                    logs_status.style.color = "#000";
                }
                else if(status=="error"){
                    logs_status.style.backgroundColor = "#DC3545";
                    logs_status.style.color = "#fff";
                }
            }
        });
        const socket = new WebSocket('ws://car.local:8765');  // Replace with the actual IP of your RPI

        socket.onmessage = function(event) {
            const base64Image = event.data;  // Receive the base64-encoded image from the server

            // Update the src of the image tag to show the received frame
            document.getElementById('live').src = 'data:image/jpeg;base64,' + base64Image;
        };

        socket.onerror = function(error) {
            console.log("WebSocket Error: " + error);
        };

        socket.onopen = function(event) {
            console.log("Connected to WebSocket server");
        };

        socket.onclose = function(event) {
            console.log("Disconnected from WebSocket server");
        };
      </script>

</body>
</html>